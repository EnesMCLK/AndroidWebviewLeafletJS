<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>MobilWeb</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
          crossorigin=""/>
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
            crossorigin=""></script>
    <script src="https://unpkg.com/leaflet-providers@latest/leaflet-providers.js"></script>
    <script src="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.js"></script>
    <style>
        body {
            padding: 0;
            margin: 0;
        }
        html, body, #map {
            height: 100%;
            width: 100vw;
        }
     </style>
    <script type="text/javascript">
        var hedef = [40.8207,29.9213];
        var animasyon = {
            duration: 3,            // Animasyon süresi (saniye cinsinden)
            easeLinearity: 0.25     // Hareketin hızı
        };
    </script>
</head>
<body>
<div id="map"></div>
    <script type="text/javascript">
        var map = L.map('map').setView([40.7, 29.9], 10);
        var startDest;
        var markers = [];
        var userLocation;
        L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '© OpenStreetMap'
        }).addTo(map);

        marker();

        // Android'e tıklama mesajı gönderme
        var marker_1 = L.marker([40.82,29.92]).addTo(map).on('click',function(e){onMarkerClick(e)});
        markers.push(marker_1);

        // Android komutu ile Webview'i kontrol etme ve Javascript fonksiyonunu çalıştırma.
        function ucus() {
            map.flyTo(hedef,15,animasyon);
        }

        function marker(){
            var marker_1425 = L.marker([40.199969, 25.91764]).addTo(map).on('click',function(e){onMarkerClick(e);});
            markers.push(marker_1425);
            var marker_1382 = L.marker([40.222927, 26]).addTo(map).on('click',function(e){onMarkerClick(e);});
            markers.push(marker_1382);
            var marker_1407 = L.marker([40.131231, 26]).addTo(map).on('click',function(e){onMarkerClick(e);});
            markers.push(marker_1407);
            var marker_1407 = L.marker([40.131231, 26]).addTo(map).on('click',function(e){onMarkerClick(e);});
            markers.push(marker_1407);
            var marker_687 = L.marker([40.178338, 26.352381]).addTo(map).on('click',function(e){onMarkerClick(e);});
            markers.push(marker_687);
            var marker_666 = L.marker([40.265433, 26.382735]).addTo(map).on('click',function(e){onMarkerClick(e);});
            markers.push(marker_666);
            var marker_3821 = L.marker([40.397938, 26.614998]).addTo(map).on('click',function(e){onMarkerClick(e);});
            markers.push(marker_3821);
            var marker_3821 = L.marker([40.397938, 26.614998]).addTo(map).on('click',function(e){onMarkerClick(e);});
            markers.push(marker_3821);
            var marker_2875 = L.marker([40.39985, 26.61512]).addTo(map).on('click',function(e){onMarkerClick(e);});
            markers.push(marker_2875);
            var marker_2875 = L.marker([40.39985, 26.61512]).addTo(map).on('click',function(e){onMarkerClick(e);});
            markers.push(marker_2875);
            var marker_3820 = L.marker([40.399563, 26.617138]).addTo(map).on('click',function(e){onMarkerClick(e);});
            markers.push(marker_3820);
            var marker_3820 = L.marker([40.399563, 26.617138]).addTo(map).on('click',function(e){onMarkerClick(e);});
            markers.push(marker_3820);
            var marker_2716 = L.marker([40.40004, 26.61746]).addTo(map).on('click',function(e){onMarkerClick(e);});
            markers.push(marker_2716);
            var marker_2716 = L.marker([40.40004, 26.61746]).addTo(map).on('click',function(e){onMarkerClick(e);});
            markers.push(marker_2716);
            var marker_3794 = L.marker([40.4135, 26.67878]).addTo(map).on('click',function(e){onMarkerClick(e);});
            markers.push(marker_3794);
            var marker_3794 = L.marker([40.4135, 26.67878]).addTo(map).on('click',function(e){onMarkerClick(e);});
            markers.push(marker_3794);
            var marker_1003 = L.marker([40.618174, 27.09923]).addTo(map).on('click',function(e){onMarkerClick(e);});
            markers.push(marker_1003);
            var marker_3823 = L.marker([40.602253, 26.904741]).addTo(map).on('click',function(e){onMarkerClick(e);});
            markers.push(marker_3823);
            var marker_3823 = L.marker([40.602253, 26.904741]).addTo(map).on('click',function(e){onMarkerClick(e);});
            markers.push(marker_3823);
            var marker_2704 = L.marker([40.603049, 26.90221]).addTo(map).on('click',function(e){onMarkerClick(e);});
            markers.push(marker_2704);
            var marker_2704 = L.marker([40.603049, 26.90221]).addTo(map).on('click',function(e){onMarkerClick(e);});
            markers.push(marker_2704);
            var marker_2703 = L.marker([40.603283, 26.902912]).addTo(map).on('click',function(e){onMarkerClick(e);});
            markers.push(marker_2703);
            var marker_2703 = L.marker([40.603283, 26.902912]).addTo(map).on('click',function(e){onMarkerClick(e);});
            markers.push(marker_2703);
            var marker_3822 = L.marker([40.603283, 26.902912]).addTo(map).on('click',function(e){onMarkerClick(e);});
            markers.push(marker_3822);
            var marker_3822 = L.marker([40.603283, 26.902912]).addTo(map).on('click',function(e){onMarkerClick(e);});
            markers.push(marker_3822);
            var marker_1000 = L.marker([40.653905, 27.055097]).addTo(map).on('click',function(e){onMarkerClick(e);});
            markers.push(marker_1000);
            var marker_1000 = L.marker([40.653905, 27.055097]).addTo(map).on('click',function(e){onMarkerClick(e);});
            markers.push(marker_1000);
            var marker_689 = L.marker([40.64003, 26.85901]).addTo(map).on('click',function(e){onMarkerClick(e);});
            markers.push(marker_689);
            var marker_689 = L.marker([40.64003, 26.85901]).addTo(map).on('click',function(e){onMarkerClick(e);});
            markers.push(marker_689);
            var marker_2565 = L.marker([40.810287, 27.035573]).addTo(map).on('click',function(e){onMarkerClick(e);});
            markers.push(marker_2565);
            var marker_2565 = L.marker([40.810287, 27.035573]).addTo(map).on('click',function(e){onMarkerClick(e);});
            markers.push(marker_2565);
            var marker_2566 = L.marker([40.811766, 27.038673]).addTo(map).on('click',function(e){onMarkerClick(e);});
            markers.push(marker_2566);
            var marker_2566 = L.marker([40.811766, 27.038673]).addTo(map).on('click',function(e){onMarkerClick(e);});
            markers.push(marker_2566);
            var marker_4804 = L.marker([40.81277, 27.038712]).addTo(map).on('click',function(e){onMarkerClick(e);});
            markers.push(marker_4804);
            var marker_4804 = L.marker([40.81277, 27.038712]).addTo(map).on('click',function(e){onMarkerClick(e);});
            markers.push(marker_4804);
            var marker_4801 = L.marker([40.810743, 27.035811]).addTo(map).on('click',function(e){onMarkerClick(e);});
            markers.push(marker_4801);
            var marker_4801 = L.marker([40.810743, 27.035811]).addTo(map).on('click',function(e){onMarkerClick(e);});
            markers.push(marker_4801);
            var marker_3999 = L.marker([40.872889, 26.993778]).addTo(map).on('click',function(e){onMarkerClick(e);});
            markers.push(marker_3999);
            var marker_1955 = L.marker([40.891754, 26.909647]).addTo(map).on('click',function(e){onMarkerClick(e);});
            markers.push(marker_1955);
            var marker_2657 = L.marker([40.884318, 26.893084]).addTo(map).on('click',function(e){onMarkerClick(e);});
            markers.push(marker_2657);
            var marker_2657 = L.marker([40.884318, 26.893084]).addTo(map).on('click',function(e){onMarkerClick(e);});
            markers.push(marker_2657);
            var marker_2321 = L.marker([40.88276, 26.88638]).addTo(map).on('click',function(e){onMarkerClick(e);});
            markers.push(marker_2321);
            var marker_2322 = L.marker([40.88125, 26.88627]).addTo(map).on('click',function(e){onMarkerClick(e);});
            markers.push(marker_2322);
            var marker_2680 = L.marker([40.873413, 26.689355]).addTo(map).on('click',function(e){onMarkerClick(e);});
            markers.push(marker_2680);
            var marker_2680 = L.marker([40.873413, 26.689355]).addTo(map).on('click',function(e){onMarkerClick(e);});
            markers.push(marker_2680);
            var marker_2584 = L.marker([40.874875, 26.662796]).addTo(map).on('click',function(e){onMarkerClick(e);});
            markers.push(marker_2584);
            var marker_2584 = L.marker([40.874875, 26.662796]).addTo(map).on('click',function(e){onMarkerClick(e);});
            markers.push(marker_2584);
            var marker_3789 = L.marker([40.875047, 26.64221]).addTo(map).on('click',function(e){onMarkerClick(e);});
            markers.push(marker_3789);
            var marker_3789 = L.marker([40.875047, 26.64221]).addTo(map).on('click',function(e){onMarkerClick(e);});
            markers.push(marker_3789);
            var marker_3789 = L.marker([40.875047, 26.64221]).addTo(map).on('click',function(e){onMarkerClick(e);});
            markers.push(marker_3789);
        }
        
        if ('geolocation' in navigator) {
            navigator.geolocation.getCurrentPosition(function(position) {
            userLocation = [position.coords.latitude, position.coords.longitude];
            // Kullanıcının konumunu haritada işaretleme
            L.marker(userLocation).addTo(map)
                .bindPopup('Buradasın')
                .openPopup();
            // Haritayı kullanıcının konumuna odaklama
            map.setView(userLocation, 13);
            startDest = userLocation;
        });
        } else {
            alert('Tarayıcında Geolocation desteklenmiyor.');
        }

        function onMarkerClick(e) {        
            var latlng = e.latlng;
            console.log("Tıklanan İşaretçinin Latitude:", latlng.lat);
            console.log("Tıklanan İşaretçinin Longitude:", latlng.lng);

            L.Routing.control({
                waypoints: [
                    startDest,
                    latlng
                ]
            }).addTo(map);
        }

        

        function findClosestMarker(clickedLatLng, markers) {
            var closestMarker = null;
            var closestDistance = Infinity;

            markers.forEach(function(marker) {
                var markerLatLng = marker.getLatLng();
                var distance = markerLatLng.distanceTo(clickedLatLng);

                if (distance < closestDistance) {
                    closestDistance = distance;
                    closestMarker = marker;
                }
            });
            return closestMarker;
        }

        function addToMarkerAtLocation(latlng) {
            markers.forEach(function(marker) {
                if (marker.getLatLng().equals(latlng)) {
                    changeMarkerColor(marker,'red');
                }
            });
        }

        function createButton(label, container) {
            var btn = L.DomUtil.create('button', '', container);
            btn.setAttribute('type', 'button');
            btn.innerHTML = label;
            return btn;
        }

        map.on('click', function(e) {
            var container = L.DomUtil.create('div'),
            startBtn = createButton('En yakın istasyonu bul', container);
            startBtn.addEventListener("click", function() {   
                // En yakın istasyonu bulma
                var closestMarker = findClosestMarker(startDest, markers);
                if (closestMarker) {
                    changeMarkerColor(closestMarker,'red');
                }
            });
            L.popup()
                .setContent(container)
                .setLatLng(e.latlng)
                .openOn(map);

  
        });

        function changeMarkerColor(marker, color) {
            var newIcon = new L.Icon({
                iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-' + color +'.png',
                shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                iconSize: [25, 41],
                iconAnchor: [12, 41],
                popupAnchor: [1, -34]
            });
            marker.setIcon(newIcon);
        }



    </script>
</body>
</html>
